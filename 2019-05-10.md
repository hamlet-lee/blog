# 调研Presto Gateway
## 项目网址
https://github.com/lyft/presto-gateway  

## 运行起来，试试CLI方式能不能正常工作  
 直接mvn install 报错。删除掉pom.xml中checkstyle相关的plugin之后，能够正常build  
 配置文件 gateway/src/main/resources/config.yml.test  
  ```yaml
  requestRouter:
    port: my-proxy-port
    name: Proxly
    cacheDir: log/prestoproxy/cache
    historySize: 1000

  backends:
    - localPort: my-local-port1
      name: presto1
      proxyTo: http://myhost1:myport1

    - localPort: my-local-port2
      name: presto2
      proxyTo: http://myhost2:myport2

  server:
    applicationConnectors:
      - type: http
        port: 23145
    adminConnectors:
      - type: http
        port: 23146

  notifier:
    smtpHost: my-smtp-host
    smtpPort: my-smtp-port
    sender: my-sender@mydomain.com
    recipients:
      - myname@mydomain.com

  modules:
    - com.lyft.data.gateway.module.ProxyBackendProviderModule
    - com.lyft.data.gateway.module.GatewayProviderModule
    - com.lyft.data.gateway.module.NotifierModule

  managedApps:
    - com.lyft.data.gateway.GatewayManagedApp
    - com.lyft.data.gateway.ActiveClusterMonitor

  # Logging settings.
  logging:
    # The default level of all loggers. Can be OFF, ERROR, WARN, INFO, DEBUG, TRACE, or ALL.
    level: INFO

    # Logger-specific levels.
    loggers:
      com.lyft: DEBUG

    appenders:
      - type: console
      - type: file
        currentLogFilename: log/prestoproxy/prestoproxy-java.log
        archivedLogFilenamePattern: log/prestoproxy/prestoproxy-java-%d{yyyy-MM-dd}-%i.log.gz
        archivedFileCount: 7
        timeZone: UTC
        maxFileSize: 100MB

  ```
  
  ```shell
  cd gateway/target/
  java -jar gateway-1.4.4-jar-with-dependencies.jar server ../src/main/resources/config.yml.test
  ```
  CLI 连接 my-proxy-port 能够正常工作
  ```
  ./presto --server my-proxy-host:my-proxy-port --catalog my-default-category --schema my-default-schema
  ```
## 检查其它API
* 查询列表的API是否正常
查询在执行中，从proxy中查到的状态如下
```json
{
    "queryId": "20190510_094037_00004_b6jbf",
    "session": {
      "queryId": "20190510_094037_00004_b6jbf",
      "transactionId": "18c87cef-8de3-41c9-a33f-be6aac4ca86c",
      "clientTransactionSupport": true,
      "user": "xxx",
      "source": "presto-cli",
      "catalog": "xxx",
      "schema": "xxx",
      "timeZoneKey": 2201,
      "locale": "en_US",
      "remoteUserAddress": "xxx",
      "userAgent": "StatementClient/0.185",
      "clientTags": [],
      "resourceEstimate": {},
      "startTime": 1557481237246,
      "systemProperties": {},
      "catalogProperties": {},
      "preparedStatements": {}
    },
    "state": "RUNNING",
    "memoryPool": "general",
    "scheduled": false,
    "self": "http://xxx/v1/query/20190510_094037_00004_b6jbf",
    "query": "select count(*) from xxx where day = '2019-05-04'",
    "queryStats": {
      "createTime": "2019-05-10T09:40:37.246Z",
      "elapsedTime": "18.48s",
      "executionTime": "18.37s",
      "totalDrivers": 117,
      "queuedDrivers": 27,
      "runningDrivers": 15,
      "completedDrivers": 58,
      "cumulativeUserMemory": 366025,
      "userMemoryReservation": "24B",
      "peakUserMemoryReservation": "24B",
      "totalCpuTime": "14.73s",
      "fullyBlocked": false,
      "blockedReasons": []
    }
  },
```
* Kill 查询 的 API
## 检查jdbc方式连接是否正常
## 检查长时间查询是否正常
## 配置多个presto集群，看是否有load balance效果
## 找到可以插入路由规则的地方

# 检查Kafka Topic的脚本
~/check.sh 
```shell
#!/bin/sh
export TOPIC=$1
echo 
echo ========== $TOPIC ==========
echo 
/path/to/kafka_2.11-0.10.0.0/bin/kafka-console-consumer.sh --zookeeper zk1:2185,zk2:2185,zk3:2185 --from-beginning --max-messages 10000 --topic $TOPIC | grep Processed
```
