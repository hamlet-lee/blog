# CentOS 7 安装 Docker
参考： https://docs.docker.com/install/linux/docker-ce/centos/

如果“物理内存”较少，可以先开个2GB的swap
```shell
dd if=/dev/zero of=/swapfile bs=1024 count=2048k
mkswap /swapfile
swapon /swapfile
chown root:root /swapfile
chmod 0600 /swapfile
```

编辑  vi /etc/fstab
```
/swapfile          swap            swap    defaults        0 0
```

确认下内存

```shell
free -h
```

接下来开始安装

```shell
yum install -y yum-utils \
  device-mapper-persistent-data \
  lvm2

yum-config-manager \
    --add-repo \
    https://download.docker.com/linux/centos/docker-ce.repo
    
yum install docker-ce docker-ce-cli containerd.io

# 启动服务
systemctl start docker

# 测试
docker run hello-world

# 让用户可以直接用docker命令
usermod -aG docker $USER
```
# 试用busybox
```
# 用busybox运行 hello world
docker run busybox echo "Hello world"

# 进入shell
docker run -it --rm busybox
```

# 创建第一个Docker映像

app.js
```javascript
const http = require('http');
const os = require('os');

console.log("Kubia server starting ...");

var handler = function(request, response) {
  console.olg("Recv request from " + request.connection.remoteAddress);
  response.writeHead(200);
  response.end("You-ve hit " + os.hostname() + "\n");
};
var www = http.createServer(handler);
www.listen(8080);
```

Dockerfile
```
FROM node:7
ADD app.js /app.js
ENTRYPOINT ["node", "app.js"]
```

创建image
```
docker build -t myimg .
```

执行输出如下：
```
Sending build context to Docker daemon  3.072kB
Step 1/3 : FROM node:7
7: Pulling from library/node
ad74af05f5a2: Pull complete 
2b032b8bbe8b: Pull complete 
a9a5b35f6ead: Pull complete 
3245b5a1c52c: Pull complete 
afa075743392: Pull complete 
9fb9f21641cd: Pull complete 
3f40ad2666bc: Pull complete 
49c0ed396b49: Pull complete 
Digest: sha256:af5c2c6ac8bc3fa372ac031ef60c45a285eeba7bce9ee9ed66dad3a01e29ab8d
Status: Downloaded newer image for node:7
 ---> d9aed20b68a4
Step 2/3 : ADD app.js /app.js
 ---> 6873e0c407f3
Step 3/3 : ENTRYPOINT ["node", "app.js"]
 ---> Running in f221755aa8fe
Removing intermediate container f221755aa8fe
 ---> 091c0ecde6c7
Successfully built 091c0ecde6c7
Successfully tagged myimg:latest
```

# Docker 列出本地的镜像 
```shell
docker images
REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE
myimg               latest              091c0ecde6c7        9 minutes ago       660MB
hello-world         latest              fce289e99eb9        5 weeks ago         1.84kB
busybox             latest              3a093384ac30        5 weeks ago         1.2MB
node                7                   d9aed20b68a4        17 months ago       660MB
```

# 执行image，形成container
```shell
docker run --name mycontainer -p 8080:8080 -d myimg
```

-d ： Daemon 方式，后台执行
-p ： 将容器里面的8080映射出来

由于使用了daemon方式执行，如果执行失败的话，不方便调试。
可以去掉`-d`试试
```shell
docker run --name mycontainer -p 8080:8080 myimg
```

如果需要删除一个container
```shell
docker rm mycontainer
```

如果需要列出所有container，包括停止的
```shell
docker container ls -a
```

如果要删除一个image
```shell
$ docker images
REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE
myimg               latest              2ab19541c580        2 minutes ago       660MB
<none>              <none>              42840e8e027c        4 minutes ago       660MB
hello-world         latest              fce289e99eb9        5 weeks ago         1.84kB
busybox             latest              3a093384ac30        5 weeks ago         1.2MB
node                7                   d9aed20b68a4        17 months ago       660MB

$ docker rmi 42840e8e027c
```

停止container
```shell
$ docker stop mycontainer
```

# Docker 进入到container里面的shell
```shell
$ docker exec -it mycontainer bash
```

# Docker 启动container，覆盖entrypoint
```shell
$ docker run --entrypoint=bash -it myimg
```
注意参数顺序，以及`-it`。
`-it`表示支持命令行交互

# 安装Minikube
参考： https://github.com/kubernetes/minikube
```shell
curl -LO https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64 \
>   && sudo install minikube-linux-amd64 /usr/local/bin/minikube

systemctl enable docker.service

minikube --vm-driver=none start
```

提示如下：

```
========================================
kubectl could not be found on your path. kubectl is a requirement for using minikube
To install kubectl, please run the following:

curl -Lo kubectl https://storage.googleapis.com/kubernetes-release/release/v1.13.2/bin/linux/amd64/kubectl && chmod +x kubectl && sudo cp kubectl /usr/local/bin/ && rm kubectl

To disable this message, run the following:

minikube config set WantKubectlDownloadMsg false
========================================
Starting local Kubernetes v1.13.2 cluster...
Starting VM...
Getting VM IP address...
Moving files into cluster...
Setting up certs...
Connecting to cluster...
Setting up kubeconfig...
Stopping extra container runtimes...
Starting cluster components...
E0205 16:25:10.551476   12799 start.go:376] Error starting cluster: kubeadm init: 
sudo /usr/bin/kubeadm init --config /var/lib/kubeadm.yaml --ignore-preflight-errors=DirAvailable--etc-kubernetes-manifests --ignore-preflight-errors=DirAvailable--data-minikube --ignore-preflight-errors=Port-10250 --ignore-preflight-errors=FileAvailable--etc-kubernetes-manifests-kube-scheduler.yaml --ignore-preflight-errors=FileAvailable--etc-kubernetes-manifests-kube-apiserver.yaml --ignore-preflight-errors=FileAvailable--etc-kubernetes-manifests-kube-controller-manager.yaml --ignore-preflight-errors=FileAvailable--etc-kubernetes-manifests-etcd.yaml --ignore-preflight-errors=Swap --ignore-preflight-errors=CRI 


: running command: 
sudo /usr/bin/kubeadm init --config /var/lib/kubeadm.yaml --ignore-preflight-errors=DirAvailable--etc-kubernetes-manifests --ignore-preflight-errors=DirAvailable--data-minikube --ignore-preflight-errors=Port-10250 --ignore-preflight-errors=FileAvailable--etc-kubernetes-manifests-kube-scheduler.yaml --ignore-preflight-errors=FileAvailable--etc-kubernetes-manifests-kube-apiserver.yaml --ignore-preflight-errors=FileAvailable--etc-kubernetes-manifests-kube-controller-manager.yaml --ignore-preflight-errors=FileAvailable--etc-kubernetes-manifests-etcd.yaml --ignore-preflight-errors=Swap --ignore-preflight-errors=CRI 

 output: [init] Using Kubernetes version: v1.13.2
[preflight] Running pre-flight checks
	[WARNING Swap]: running with swap on is not supported. Please disable swap
	[WARNING FileExisting-socat]: socat not found in system path
	[WARNING SystemVerification]: this Docker version is not on the list of validated versions: 18.09.1. Latest validated version: 18.06
	[WARNING Hostname]: hostname "minikube" could not be reached
	[WARNING Hostname]: hostname "minikube": lookup minikube on 100.100.2.136:53: no such host
error execution phase preflight: [preflight] Some fatal errors occurred:
	[ERROR NumCPU]: the number of available CPUs 1 is less than the required 2
[preflight] If you know what you are doing, you can make a check non-fatal with `--ignore-preflight-errors=...`
: running command: 
sudo /usr/bin/kubeadm init --config /var/lib/kubeadm.yaml --ignore-preflight-errors=DirAvailable--etc-kubernetes-manifests --ignore-preflight-errors=DirAvailable--data-minikube --ignore-preflight-errors=Port-10250 --ignore-preflight-errors=FileAvailable--etc-kubernetes-manifests-kube-scheduler.yaml --ignore-preflight-errors=FileAvailable--etc-kubernetes-manifests-kube-apiserver.yaml --ignore-preflight-errors=FileAvailable--etc-kubernetes-manifests-kube-controller-manager.yaml --ignore-preflight-errors=FileAvailable--etc-kubernetes-manifests-etcd.yaml --ignore-preflight-errors=Swap --ignore-preflight-errors=CRI 

.: exit status 1
```

参考： Environment="KUBELET_EXTRA_ARGS=--fail-swap-on=false"
```shell
vi /etc/systemd/system/kubelet.service.d/10-kubeadm.conf
```

加入：
```
Environment="KUBELET_EXTRA_ARGS=--fail-swap-on=false"
```
