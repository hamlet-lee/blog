# 通过 openvpn 访问 minikube 内部网络
## OpenVPN 服务端
1. 下载项目
    ```shell
    git clone https://github.com/shyiko/k8sovpn.git
    cd k8sovpn
    mkdir my
    cd my
    ```

1. generate key
    ```shell
    # generate
    # - CA certificate/private key;
    # - server certificate/private key;
    # - Diffie-Hellman parameters file;
    # - tls-auth key.
    # 
    # output:  
    # ./pki/ca.crt
    # ./pki/crl.pem
    # ./pki/dh.pem
    # ./pki/issued/server.crt
    # ./pki/private/ca.key
    # ./pki/private/server.key
    # ./ta.key
    #
    docker run -v $(pwd):/workdir -w /workdir --rm -it \
      -e ROOT_CN=myhost \
      shyiko/openvpn:2.4.0_easyrsa-3.0.3 \
      bash -c '
      export EASYRSA_PKI=$(pwd)/pki
      easyrsa init-pki
      printf "$ROOT_CN\n" | easyrsa build-ca nopass 
      easyrsa gen-crl
      easyrsa build-server-full server nopass 
      easyrsa gen-dh
      openvpn --genkey --secret ta.key
      '
    ```

1. 创建给server用的secret
    ```shell
    # create a secret containing everything but CA private key (keep it safe!)
    kubectl create secret generic k8sovpn \
      --from-file=pki/ca.crt \
      --from-file=pki/crl.pem \
      --from-file=pki/dh.pem \
      --from-file=pki/issued/server.crt \
      --from-file=pki/private/server.key \
      --from-file=ta.key
    ```

1. 启动ovpn的deploy
    ```shell
    kubectl apply -f ../k8sovpn.yml
    ```

1. 启动ovpn的service
    ```shell
    kubectl expose deployment/k8sovpn --port=1194 --type=NodePort
    ```

## 准备客户端 .ovpn 文件
    # generate client certificate/private key and then pack everything in .ovpn 
    # (OpenVPN client configuration)
    #
    # output:  
    # ./pki/issued/$CLIENT_NAME.crt
    # ./pki/private/$CLIENT_NAME.key
    # ./$CLIENT_NAME.ovpn
    #

    # minikube ip => 192.168.99.113
    # kubectl get svc => 30393

    docker run -v $(pwd):/workdir -w /workdir --rm -it \
      -e REMOTE_HOST=192.168.99.113 \
      -e REMOTE_PORT=30393 \
      -e CLIENT_NAME=my \
      shyiko/openvpn:2.4.0_easyrsa-3.0.3 \
      bash -c '
      export EASYRSA_PKI=$(pwd)/pki
      easyrsa build-client-full $CLIENT_NAME nopass
      printf "client
    verb 3  
    remote $REMOTE_HOST $REMOTE_PORT
    persist-key
    persist-tun
    proto udp
    nobind
    dev tun
    cipher AES-128-GCM
    <ca>\n$(cat pki/ca.crt)\n</ca>
    <key>\n$(cat pki/private/$CLIENT_NAME.key)\n</key>
    <cert>\n$(cat pki/issued/$CLIENT_NAME.crt)\n</cert>
    remote-cert-tls server
    <tls-auth>\n$(cat ta.key)\n</tls-auth>
    key-direction 1
    " > /workdir/$CLIENT_NAME.ovpn
      '
