# Logstash 运行多个instance
* 参考：https://discuss.elastic.co/t/run-multiple-instance-of-logstash/92456/4

需要指定不同的path.data，例如

```shell
mkdir -p data/xxx
logstash -f xxx.conf --path.data=data/xxx
```

# Logstash 解析access log

* 参考1：config examples : https://www.elastic.co/guide/en/logstash/current/config-examples.html

* 参考2：grok的pattern定义：https://github.com/logstash-plugins/logstash-patterns-core/blob/4ba9bf573583ad510aaf4bd0b3418bdbe3402585/patterns/httpd

* 参考3：uri 解析： https://discuss.elastic.co/t/grok-uri-extract/54836/2

## 解析默认格式
```ruby
filter {
  grok {
    match => { "message" => "%{HTTPD_COMBINEDLOG}" }
  }
}
```

## Logstash 解析URL
如下可以实现，解析parameters

```
kv {
                source => "uri_query"
                field_split => "&"
                prefix => "query_"
        }
```

结果示例

```
{
       "uri_query" => "application=&inf.name=eth0&test1=blah&test2=blahblahblah",
       "query_inf.name" => "eth0",
       "query_test1" => "blah",
       "query_test2" => "blahblahblah"
}
```

如下可以实现，解析的parameters放在一个嵌套结构中
```
filter {
  grok {
    match => [ "url", "%{URIPROTO:uri_proto}://(?:%{USER:user}(?::[^@]*)?@)?(?:%{URIHOST:uri_domain})?(?:%{URIPATHPARAM:uri_param})?" ]
  }
  grok {
    match => [ "uri_param", "%{GREEDYDATA:uri_path}\?%{GREEDYDATA:uri_query}" ]
  }

  kv {
    source => "uri_query"
    field_split => "&"
    target => "query"
  }
}
```

```
 "url" => "http://cdn1cdedge0001.coxlab.net/_astats?application=&inf.name=eth0",
 "uri_proto" => "http",
 "uri_domain" => "cdn1cdedge0001.coxlab.net",
 "uri_param" => "/_astats?application=&inf.name=eth0",
 "uri_path" => "/_astats",
 "uri_query" => "application=&inf.name=eth0",
 "query" => {
    "inf.name" => "eth0"
 }
```

如下可以实现第一个不匹配时，匹配第二个
```
  grok {
      break_on_match => true
      match => [ "uri_param", "%{GREEDYDATA:uri_path}\?%{GREEDYDATA:uri_query}" ,
                 "uri_param","%{GREEDYDATA:uri_path}"
               ]
  }
```
