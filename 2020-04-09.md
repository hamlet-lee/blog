# Knox 代码分析
图片待补充。  
用YARNUI查看Job History的过程，分析了knox的工作路径。  

```
访问 http://YARN/cluster
service.xml
        <route path="/yarn/cluster/**?**">
            <rewrite apply="YARNUI/yarn/outbound/headers/jobhistory/job" to="response.headers"/>
            <rewrite apply="YARNUI/yarn/outbound/filter/cluster" to="response.body"/>  <!-- apply 对应下面的 filter name -->
        </route>

rewrite.xml:
<filter name="YARNUI/yarn/outbound/filter/cluster">
    <content type="*/html">
        <apply path="(https?://[^/':,]+:[\d]+)?/ws/v1/cluster/apps/application" rule="YARNUI/yarn/outbound/apps/cluster1"/>
        <apply path="https?://[^/':,]+:[\d]+/cluster/scheduler.*" rule="YARNUI/yarn/outbound/scheduler1"/>
        <apply path="/cluster/scheduler.*" rule="YARNUI/yarn/outbound/scheduler2"/>
        <apply path="(https?://[^/':,]+:[\d]+)?/cluster/app/application" rule="YARNUI/yarn/outbound/cluster/app/application"/>
        <apply path="(https?://[^/':,]+:[\d]+)?/proxy/[^']*" rule="YARNUI/yarn/outbound/apps/history"/> <!-- rule 对应下面的 rule name -->
        <apply path="/cluster/appatt" rule="YARNUI/yarn/outbound/apps/appatt"/>
        <apply path="(https?:)?//[^/':,]+:[\d]+/node/containerlogs/container(_[^/':,]+)+/[^/':,]+" rule="YARNUI/yarn/outbound/node/containerlogs"/>
        <apply path="/cluster/container" rule="YARNUI/yarn/outbound/cluster/container"/>
        <apply path="https?://[^/':,]+:[\d][^']*" rule="YARNUI/yarn/outbound/node2"/>
    </content>
</filter>



<rule dir="OUT" name="YARNUI/yarn/outbound/apps/history"> <!-- OUT 表示返回方向数据的规则 -->
    <match pattern="*://*:*/proxy/{**}"/>
    <rewrite template="{$frontend[url]}/yarn/proxy/{**}"/>
</rule>


----------------------------------------------------------------
访问：http://YARN/yarn/proxy/appid
        <route path="/yarn/proxy/**">
            <rewrite apply="YARNUI/yarn/outbound/headers/jobhistory/job" to="response.headers"/>
            <rewrite apply="YARNUI/yarn/outbound/apps1" to="response.body"/> <!-- apply => filter.name -->
        </route>
		
		
<filter name="YARNUI/yarn/outbound/headers/jobhistory/job">
    <content type="application/x-http-headers">
        <apply path="Location" rule="YARNUI/yarn/outbound/headers/jobhistory/job/location"/> <!-- rule => rule.name -->
    </content>
</filter>


<rule flow="OR" dir="OUT" name="YARNUI/yarn/outbound/headers/jobhistory/job/location">  <!-- dir=OUT 表示出knox站方向 -->
    <match pattern="{scheme}://{host}:{port}/jobhistory/job/{**}">
        <rewrite template="{$frontend[url]}/yarn/jobhistory/job/{**}?{scheme}?{host}?{port}"/>
    </match>
    <match pattern="*://*:*/history/{**}?{**}">
        <rewrite template="{gateway.scheme}://{gateway.host}:{gateway.port}/gateway/sparkui/spark/history/{**}?{**}"/>
    </match>
    <match pattern="*://*:*/cluster/app/{**}">
        <rewrite template="{$frontend[url]}/yarn/cluster/app/{**}"/>
    </match>
    <match pattern="*://*:*/cluster/apps/{**}">
        <rewrite template="{$frontend[url]}/yarn/cluster/apps/{**}"/>
    </match>
    <match pattern="*://*:*/cluster/apps">
        <rewrite template="{$frontend[url]}/yarn/cluster/apps"/>
    </match>
    <match pattern="*://*:*/cluster">
        <rewrite template="{$frontend[url]}/yarn/cluster"/>
    </match>

</rule>
-------------------------------------------------
访问  http://YARN/yarn/jobhistory/job/appid?host&port&scheme

<!-- dir=IN 表示入knox站方向 -->
<rule dir="IN" name="YARNUI/yarn/inbound/jobhistory/job" pattern="*://*:*/**/yarn/jobhistory/job/{**}?{scheme}?{host}?{port}">
    <rewrite template="{scheme}://{host}:{port}/jobhistory/job/{**}"/>
</rule>
```
